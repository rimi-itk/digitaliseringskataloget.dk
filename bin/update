#!/usr/bin/env sh

project_dir=$(pwd)
target_dir="$project_dir/_site"

exec_unzip() {
    unzip -O CP850 -q "$@"
}

do_it() {
    source_url="$1"
    target_path="$target_dir/digitaliseringskataloget.dk/$2"

    mkdir -p "$target_path"

    tmp_filename="$target_dir/tmp.zip"

    cd "$target_dir" || exit
    echo "Fetching $source_url"
    curl --silent --location "$source_url" >| "$tmp_filename"

    echo "Extracting in $target_path"
    rm -fr "$target_path"
    mkdir -p "$target_path"
    cd "$target_path" || exit
    exec_unzip -o "$tmp_filename" #> /dev/null 2>&1

    while true; do
        archive=$(find . -name "*.zip" -print0 -quit)
        if [ -z "$archive" ]; then
            break
        else
            echo "Extracting $archive"
            exec_unzip -d "$(dirname "$archive")" -o "$archive" #> /dev/null 2>&1
            rm "$archive"
        fi
    done
}

cd "$project_dir" || exit

rm -fr digitaliseringskataloget.dk/

# https://digitaliseringskataloget.dk/integration/sf1461
# do_it 'https://docs.kombit.dk/integration/sf1461/1.0/pakke' 'sf1461/1.0'
do_it 'https://docs.kombit.dk/integration/sf1461/2.0/pakke' 'sf1461/2.0'

# https://digitaliseringskataloget.dk/integration/sf1601
do_it 'https://docs.kombit.dk/integration/sf1601/1.0/pakke' 'sf1601/1.0'

# https://digitaliseringskataloget.dk/integration/sf1500
# do_it 'https://docs.kombit.dk/integration/sf1500/3.0/pakke' 'sf1500/3.0'
do_it 'https://docs.kombit.dk/integration/sf1500/3.2/pakke' 'sf1500/3.2'

# https://digitaliseringskataloget.dk/integration/sf1520
# do_it 'https://docs.kombit.dk/integration/sf1520/3.6/pakke' 'sf1520/3.6'
do_it 'https://docs.kombit.dk/integration/sf1520/4.0/pakke' 'sf1520/4.0'

# https://digitaliseringskataloget.dk/integration/sf2900
do_it 'https://docs.kombit.dk/integration/sf2900/2.4/pakke' 'sf2900/2.4'

cd "$target_dir" || exit

for type in pdf wsdl xml xsd; do
    echo "type: $type"
    tree --prune --noreport -H '' -T 'digitaliseringskataloget.dk' --charset utf-8 -P "*.$type" -o "$target_dir/$type.html" --houtro=../resources/outro.html digitaliseringskataloget.dk

    # Decode some characters.
    sed --in-place \
        -e 's/%FFFFFFC3%FFFFFFA6/æ/' \
        -e 's/%FFFFFFC3%FFFFFFB8/ø/' \
        -e 's/%FFFFFFC3%FFFFFFA5/å/' \
        "$type.html"

    # Unwrap directory links.
    sed --in-place \
        -e 's~<a href="[^>]*/">\([^<]*\)</a>~\1~' \
        "$type.html"
done

cp "$target_dir/pdf.html" "$target_dir/index.html"
