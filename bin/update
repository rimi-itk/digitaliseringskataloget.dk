#!/usr/bin/env bash
# set -o errexit -o errtrace -o noclobber -o nounset -o pipefail
IFS=$'\n\t'

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
project_dir=$(cd "$script_dir"/../ && pwd)
bold=$(tput bold)
normal=$(tput sgr0)

do_it() {
    source_url="$1"
    target_path="$project_dir/$2"

    tmp_filename="$project_dir/tmp.zip"

    cd "$project_dir" || exit
    echo "${bold}Fetching $source_url${normal}"
    curl --silent --location "$source_url" >| "$tmp_filename"

    echo "${bold}Extracting in $target_path${normal}"
    rm -fr "$target_path"
    mkdir -p "$target_path"
    cd "$target_path" || exit
    unzip -o "$tmp_filename" > /dev/null 2>&1

    while true; do
        archive=$(find . -name "*.zip" -print0 -quit)
        if [ -z "$archive" ]; then
            break
        else
            echo "${bold}Extracting $archive${normal}"
            unzip -d "$(dirname "$archive")" -o "$archive" #> /dev/null 2>&1
            rm "$archive"
        fi
    done

    find "$target_path" -type f
}

# https://digitaliseringskataloget.dk/integration/sf1461
do_it 'https://docs.kombit.dk/integration/sf1461/1.0/pakke' 'sf1461'

# https://digitaliseringskataloget.dk/integration/sf1601
do_it 'https://docs.kombit.dk/integration/sf1601/1.0/pakke' 'sf1601'
